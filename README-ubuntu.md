# üìö Guide Complet de Configuration et S√©curisation d'un VPS avec NGINX et NGINX Amplify

> Ce guide approfondi vous guide pas √† pas dans le processus de configuration et de s√©curisation de votre VPS. Il couvre tout, depuis la cr√©ation des cl√©s SSH jusqu'√† l'installation de NGINX, en passant par NGINX Amplify ‚Äì un agent performant et optimis√©, ainsi que la configuration du pare-feu. Chaque √©tape est minutieusement d√©taill√©e pour assurer une mise en place efficace et une s√©curit√© optimale de votre environnement serveur. üöÄüíºüîßüåêüîí

---

## A EDITER

```sh
scp -r C:/Users/toto/Documents/www/Vue/projects/nom_projet/client-build/* demo@WW.XX.YY.ZZ:/var/www/nom_projet.fr/html
```

## üìã Pr√©-requis

Avant de commencer, v√©rifiez que vous disposez de :

1. **Un VPS avec Ubuntu Server d√©j√† install√©**.
2. **Acc√®s root ou avec des privil√®ges sudo**.
3. **Connaissances de base en ligne de commande Linux**.
4. **Un client SSH sur votre machine locale**

    - Par exemple, PuTTY pour **_Windows_** ou le terminal int√©gr√© dans Linux et macOS.
    - Sur VS Code, utilisez ces extensions utiles disponibles sur le [marketplace officiel](https://marketplace.visualstudio.com/vscode) :
        - [Remote Development](https://marketplace.visualstudio.com/items?itemName=ms-vscode-remote.vscode-remote-extensionpack)
        - [Remote - SSH](https://marketplace.visualstudio.com/items?itemName=ms-vscode-remote.remote-ssh)
        - [Remote Exporer](https://marketplace.visualstudio.com/items?itemName=ms-vscode.remote-explorer)
        - [Remote - SSH:Editing Configuration Files](https://marketplace.visualstudio.com/items?itemName=ms-vscode-remote.remote-ssh-edit)
        - [Remote - Tunnels](https://marketplace.visualstudio.com/items?itemName=ms-vscode.remote-server)
        - [Remote Repositories](https://marketplace.visualstudio.com/items?itemName=ms-vscode.remote-repositories)

5. **Notions de base sur Docker et NGINX**.

Avec ces pr√©-requis en place, vous √™tes pr√™t √† commencer la configuration de votre VPS.
Suivez les √©tapes d√©crites dans ce guide pour une mise en place r√©ussie et s√©curis√©e de votre environnement serveur. üöÄüíºüîß

---

## 1 - Configuration Initiale de son VPS

1. **üåê Connexion SSH Initiale**
    1. **‚¨ÜÔ∏è Mettre √† jour son VPS**
    2. **üö™ Modifier le port d'√©coute SSH par d√©faut**
    3. **üîë Cr√©ation et Configuration des Cl√©s SSH**
    4. **üîí Copie de la Cl√© Publique sur le Serveur**
    5. **üõ†Ô∏è Installation Manuelle de la Cl√© (_si n√©cessaire_)**
    6. **üë§ Cr√©ation d'un Nouvel Utilisateur**
    7. **üîê D√©sactivation de l'Authentification par Mot de Passe**
2. **üöÄ Installation de NGINX Ampify**

### 1.1 - üåê Connexion SSH Initiale

```sh
# Connexion au VPS via SSH via un terminal
ssh utilisateur@adresse_ip_vps
```

-   Remplacez **_`utilisateur`_** par votre nom d'utilisateur (ex: **_`ubuntu`_** pour un syst√®me Ubuntu sur un VPS chez OVH).
-   Remplacez **_`adresse_ip_vps`_** par l'adresse IP de votre VPS qui vous aura √©t√© communiqu√©e par email.

### 1.2 - Mettre √† jour son VPS

Mettre √† jour r√©guli√®rement son syst√®me est crucial pour la s√©curit√© du VPS.
En effet, les d√©veloppeurs de distributions et de syst√®mes d‚Äôexploitation proposent de fr√©quentes mises √† jour de paquets, tr√®s souvent pour des raisons de s√©curit√©.

```bash
# Mise √† jour de la liste des paquets et des paquets eux-m√™mes
sudo apt update -y && sudo apt upgrade -y && sudo apt autoremove -y
```

üî• **IMPORTANT** - **Effectuez r√©guli√®rement cette op√©ration pour maintenir un syst√®me √† jour**.

### 1.3 - üö™ Modification du Port d'√âcoute SSH par D√©faut

Changer le port SSH par d√©faut (**22**) au profit d'un port diff√©rent r√©duit le risque d'attaques automatis√©es. (_tentatives de hack du serveur par des robots_)
Utilisez un port non-standard, de pr√©f√©rence entre **49152** et **65535**.

> La modification de ce param√®tre, a, est une mesure simple pour renforcer la protection de votre serveur contre les attaques automatis√©es.
> **Pour cela, il faut modifier le fichier de configuration du service avec l'√©diteur de texte de votre choix (\_**nano** est utilis√© dans le terminal dans cet exemple\_) :**

**Exemple ici avec la d√©finition du port 50001** :

```bash
# Passer en administrateur
sudo su

# Edition du fichier sshd_config se trouvant dans le r√©pertoire /etc/ssh/
cd /etc/ssh

# Voir le contenu du r√©pertoire ssh
ls ssh

# Edition du fichier de configuration avec nano
nano sshd_config
```

Vous devriez trouver les lignes suivantes ou √©quivalentes :

```sh
# ... d'autres lignes de code

#Port 22
#AddressFamily any
#ListenAddress 0.0.0.0
#ListenAddress ::

# ... encore d'autres lignes de code
```

Remplacez par

```bash
# ... d'autres lignes de code

Port 50001
#AddressFamily any
#ListenAddress 0.0.0.0
#ListenAddress ::

# ... encore d'autres lignes de code
```

Donc ici, nous avons remplac√© le nombre **_`22`_** par le num√©ro de port de suivant **_`50001`_**.
Enregistrez (**_`CTRL + S`_**) et quittez (**_`CTRL + X`_**). Puis effectuez la commande suivante :

```bash
# Red√©marrer le service SSH pour appliquer les changements.
sudo systemctl restart sshd

# En cas de probl√®me, red√©marrez le VPS : sudo reboot
# Cela devrait √™tre suffisant pour appliquer les changements.
# Dans le cas contraire, red√©marrez le VPS avec cette commande :
sudo reboot
```

‚ö†Ô∏è **ATENTION** - Pour se connecter apr√®s ce changement :

```bash
# Connexion au VPS via SSH avec le nouveau port
ssh utilisateur@adresse_ip_vps -p 50001
```

_Vous devrez indiquer le nouveau port √† chaque demande de connexion SSH √† votre serveur._

### 1.4 - üîë Cr√©ation et Configuration des Cl√©s SSH

```bash
# G√©n√©rez une paire de cl√©s SSH sur votre machine locale
ssh-keygen -t ed25519 -C "description_de_la_cle"
```

### 1.5 - Copie de la Cl√© Publique sur le Serveur

> ‚ö†Ô∏è **ATTENTION** - Assurez-vous de copier uniquement la cl√© **id_ed25519.pub**

```bash
# Copier la cl√© publique sur le serveur VPS
ssh-copy-id -i ./id_ed25519.pub utilisateur@ip_ovh
```

### 1.6 - Installation Manuelle de la Cl√© (Si N√©cessaire)

Sur Windows, si `ssh-copy-id` n'est pas disponible, suivez ces √©tapes :

```bash
# Connexion au serveur VPS via SSH
ssh utilisateur@ip_ovh

# Acc√©der au dossier .ssh de l'utilisateur
cd .ssh

# Afficher le contenue du r√©pertoire cach√© ".ssh"
ls -lah

# √âditer le fichier authorized_keys pour ajouter la cl√© publique
sudo nano authorized_keys

# Copier manuellement la cl√© publique g√©n√©r√©e √† l'√©tape 1
# Enregistrer avec "CTRL + S" et quitter avec "CTRL + X"

# Afficher le contenu de authorized_keys pour v√©rifier
cat authorized_keys
```

### 1.7 - üë§ Cr√©ation d'un Nouvel Utilisateur

```bash
# Pour ajouter un utilisateur avec des droits restreints:
sudo adduser nom_utilisateur

# Pour ajouter un utilisateur avec des droits sudo :
sudo adduser nom_utilisateur
sudo usermod -aG sudo nom_utilisateur
```

### 1.8 - üîê D√©sactivation de l'Authentification par Mot de Passe

Pour plus de s√©curit√©, d√©sactivez l'authentification par mot de passe.
Pour cel√†, nous devons √† nouveau modifier le fichier que l'on a modifi√© √† l'√©tape `1.2`.

> ‚ö†Ô∏è **ATTENTION** - Assurez-vous d'avoir copier votre cl√© ssh. Auquel cas la connexion sera impossible.

```bash
# D√©placement dans le r√©pertoire correspondant
cd /etc/ssh

# Ouvrir le fichier de configuration SSH pour modification
sudo nano sshd_config
```

Modifiez :

```bash
PasswordAuthentication yes
PermitRootLogin yes
```

en :

```bash
PasswordAuthentication no
PermitRootLogin no
```

Enregistrez (`CTRL + S`) et quittez (`CTRL + X`), puis red√©marrez SSH.

---

## 2 - Installation et Configuration de NGINX

### üåç 2.1 Installation de NGINX

```bash
# Mettre √† jour les paquets et installer NGINX
sudo apt update && sudo apt upgrade -y && sudo apt install nginx

# D√©marrer et activer NGINX
sudo systemctl start nginx # D√©marre
sudo systemctl enable nginx # Active au d√©marrage
```

### üìÑ 2.2 Configuration de NGINX pour Plusieurs Sites

**NOTE:** - R√©p√©tez ces √©tapes pour chaque site :

```bash
# Cr√©er un r√©pertoire pour le site et configurer les permissions
sudo mkdir -p /var/www/site1.com/html
sudo chown -R $USER:$USER /var/www/site1.com/html

# Cr√©er et √©diter la configuration du site dans NGINX
sudo nano /etc/nginx/sites-available/site1.com

# Activer le site en cr√©ant un lien symbolique
sudo ln -s /etc/nginx/sites-available/site1.com /etc/nginx/sites-enabled/

# Tester et red√©marrer NGINX pour appliquer les changements
sudo nginx -t
sudo systemctl restart nginx
```

---

## 3 - Installation de Docker sur le VPS

```bash
# Installer Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh ./get-docker.sh --dry-run

# V√©rification de l'installation
docker -v
```

[Source officiel](https://docs.docker.com/engine/install/ubuntu/#install-using-the-convenience-script)

### üê≥ 3.1 Commandes Docker

#### 3.1.1 Windows

```bash
# T√©l√©charger une image nginx
docker pull nginx

# Lancer un conteneur avec l'image nginx
docker run --name docker-nginx -p 80:80 nginx

# V√©rifier que NGINX fonctionne
sudo ps -ef | grep nginx

# Afficher toutes les VM lanc√©s
docker ps

# Afficher les conteneurs actifsAjout du fichier changelog
docker container ls

# Afficher les images disponibles
docker images ls

# Stoper un container (ici docker-nginx d√©fini plus haut)
docker stop docker-nginx

# Supprimer un container
docker rm docker-nginx
```

**Visitez `localhost` dans votre navigateur pour voir NGINX en action.**

### 3.2 Lancer le Service NGINX

Uniquement si le serveur n'est pas d√©marr√©.

```bash
# D√©marrer le service NGINX
sudo service nginx start
```

---

## üî• 4 - S√©curisation et Pare-feu

### 4.1 Configuration du Pare-feu UFW

```bash
# Installer et configurer UFW (Uncomplicated Firewall)
sudo apt install ufw

# Autoriser le trafic SSH sur les nouveaux ports
sudo ufw allow 50001/tcp # Pour le premier VPS
sudo ufw allow 50002/tcp # Pour le second VPS (si il y en a un)

# Autoriser le trafic pour NGINX
sudo ufw allow 'Nginx Full'

# Activer UFW
sudo ufw enable

# V√©rifier le statut du pare-feu
sudo ufw status
```

---

## 5 - Nginx Amplify

### 5.1 - Installation de NGINX Amplify üîß

NGINX Amplify est un outil performant offrant des m√©triques d√©taill√©es pour surveiller l'√©tat de votre serveur NGINX.

Pour l'installer :

1. **Cr√©ez un compte sur NGINX Amplify** üìù: Rendez-vous sur [le site de NGINX Amplify](https://www.nginx.com/products/nginx-amplify/) pour vous inscrire.
2. **T√©l√©chargez et installez l'agent NGINX Amplify**

Connectez-vous en SSH √† votre serveur et suivez ces √©tapes :

-   Connectez-vous en tant que root üë§:

```bash
# Au cas o√π, voici la commande pour se connecter en root
sudo su
```

-   T√©l√©chargez üì• le script d'installation.
-   Ex√©cutez la commande d'installation en tant que root üë®‚Äçüíª.
-   Suivez les instructions √† l'√©cran et cliquez sur `Continue` ‚úÖ.

Pour v√©rifier et g√©rer l'agent NGINX Amplify :

```bash
# V√©rifier si l'agent NGINX Amplify est install√© et actif üîç
sudo service amplify-agent status

# D√©marrer l'agent NGINX Amplify, si n√©cessaire üü¢
sudo service amplify-agent start

# Arr√™ter l'agent NGINX Amplify üî¥
sudo service amplify-agent stop
```

### 5.2 - Configuration Nginx pour visualiser les m√©triques üìä

Pour configurer NGINX afin de visualiser les m√©triques avec NGINX Amplify, suivez ces √©tapes : (_Header violet_)

Il faut simplement suivre chacune des √©tapes affich√© √† l'√©cran

1. Acc√©dez au r√©pertoire de configuration de NGINX üìÅ:
    ```bash
    cd /etc/nginx
    ```
2. V√©rifiez que les fichiers de configuration additionnels sont inclus üîç:
    ```bash
    grep -i include\.*conf nginx.conf
    ```
3. Cr√©ez une nouvelle configuration pour `stub_status` üìù:
    ```bash
    cat > conf.d/stub_status.conf
    ```
    Puis, copiez et collez le contenu suivant üìã:
    ```nginx
    server {
        listen 127.0.0.1:80;
        server_name 127.0.0.1;
        location /nginx_status {
            stub_status on;
            allow 127.0.0.1;
            deny all;
        }
    }
    ```
4. V√©rifiez et affichez le contenu du fichier de configuration üñ•Ô∏è:
    ```bash
    ls -la conf.d/stub_status.conf && cat conf.d/stub_status.conf
    ```
5. Rechargez la configuration NGINX üîÅ:
    ```bash
    kill -HUP `cat /var/run/nginx.pid`
    ```
